<main class="neg-detail" *ngIf="neg() as n; else notfound">
  <nav class="breadcrumb">
    <a routerLink="/negociacoes">Minhas negociações</a>
    <span>/</span>
    <span>#{{ n.id.slice(0, 8) }}</span>
  </nav>

  <section class="summary-card">
    <div class="summary-left">
      <span class="role-chip" [class.buyer]="isBuyer()" [class.seller]="isSeller()">{{ roleLabel() }}</span>
      <h1>Negociação #{{ n.id.slice(0, 8) }}</h1>
      <p class="muted">Aberta em {{ n.createdAt | date:'short' }}</p>
      <p class="muted" *ngIf="n.acceptedAt">Aceita em {{ n.acceptedAt | date:'short' }}</p>
    </div>

    <div class="summary-right">
      <span class="status-chip"
        [class.pend]="n.status==='esperando_pagamento' || n.status==='PENDING_SELLER_ACCEPT'"
        [class.act]="n.status==='aguardando_envio' || n.status==='encaminhada' || n.status==='ACTIVE' || n.status==='WAITING_BUYER' || n.status==='WAITING_SELLER'"
        [class.done]="n.status==='concluido' || n.status==='concluído' || n.status==='COMPLETED'"
        [class.cancel]="n.status==='CANCELLED'"
        [class.exp]="n.status==='EXPIRED'">
          {{ (n.status ?? '') | statusLabel }}
      </span>
      <a routerLink="/negociacoes" class="btn secondary">Voltar</a>
    </div>
  </section>

  <section class="info-grid">
    <div class="info-card">
      <span class="label">Participante</span>
      <strong>{{ counterparty(n).nome || '—' }}</strong>
      <small class="muted" *ngIf="counterparty(n).cidade || counterparty(n).estado">
        {{ counterparty(n).cidade || 'Cidade não informada' }}
        <span *ngIf="counterparty(n).estado"> / {{ counterparty(n).estado }}</span>
      </small>
    </div>
    <div class="info-card">
      <span class="label">Situação de pagamento</span>
      <strong>{{ getPaymentStatus(n) }}</strong>
      <small class="muted" *ngIf="n.payment?.method">{{ n.payment?.method }}</small>
    </div>
    <div class="info-card">
      <span class="label">Código de rastreio</span>
      <strong *ngIf="getTrackingCode(n); else noTracking">{{ getTrackingCode(n) }}</strong>
      <ng-template #noTracking>—</ng-template>
      <small class="muted" *ngIf="trackingList(n).length > 1">{{ trackingList(n).length }} códigos</small>
    </div>
    <div class="info-card">
      <span class="label">Itens</span>
      <strong>{{ n.items.length }}</strong>
      <small class="muted">Total de anúncios incluídos</small>
    </div>
    <div class="info-card">
      <span class="label">Total da negociação</span>
      <strong>R$ {{ n.totalPrice | number:'1.2-2' }}</strong>
    </div>
  </section>

  <section class="parties">
    <div class="card">
      <h3>Vendedor</h3>
      <p><strong>{{ n.seller.nome }}</strong></p>
      <p class="muted" *ngIf="n.seller.cidade || n.seller.estado">
        {{ n.seller.cidade || 'Cidade não informada' }}<span *ngIf="n.seller.estado"> / {{ n.seller.estado }}</span>
      </p>
      <p class="muted" *ngIf="n.seller.email">{{ n.seller.email }}</p>
    </div>
    <div class="card">
      <h3>Comprador</h3>
      <p><strong>{{ n.buyer.nome }}</strong></p>
      <p class="muted" *ngIf="n.buyer.cidade || n.buyer.estado">
        {{ n.buyer.cidade || 'Cidade não informada' }}<span *ngIf="n.buyer.estado"> / {{ n.buyer.estado }}</span>
      </p>
      <p class="muted" *ngIf="n.buyer.email">{{ n.buyer.email }}</p>
    </div>
  </section>

  <section class="items">
    <h3>Itens negociados</h3>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Condição</th>
          <th>Envio</th>
          <th>Preço</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let it of n.items">
          <td>
            <div class="item-info">
              <img *ngIf="it.image" [src]="it.image" alt="" class="cover" />
              <div>
                <div class="title">{{ it.titulo }}</div>
                <div class="muted">{{ it.autor || 'Autor não informado' }}</div>
                <div class="muted">Qtd: {{ it.quantidade }}</div>
              </div>
            </div>
          </td>
          <td>{{ it.condicao || '-' }}</td>
          <td>{{ it.shipping || '-' }}</td>
          <td>R$ {{ it.preco | number:'1.2-2' }}</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3"><strong>Total</strong></td>
          <td><strong>R$ {{ n.totalPrice | number:'1.2-2' }}</strong></td>
        </tr>
      </tfoot>
    </table>
  </section>

  <section class="action-panels">
    <div class="card action-card">
      <header>
        <h3>Minhas ações</h3>
        <span class="badge-role" [class.buyer]="isBuyer()" [class.seller]="isSeller()">{{ roleLabel() }}</span>
      </header>

      <div *ngIf="isSeller()">
        <button
          *ngIf="!n.acceptedAt"
          class="btn"
          (click)="accept(n.id)">
          Aceitar negociação
        </button>

        <div class="action-buttons-row" *ngIf="sellerMustAct(n)">
          <button
            class="btn tertiary"
            (click)="openAction('shipment')">
            Fiz minha parte
          </button>
        </div>

        <div *ngIf="n.shipment?.sentAt" class="muted mtop">
          Enviado em {{ n.shipment?.sentAt | date:'short' }}
          <span *ngIf="n.shipment?.carrier"> — {{ n.shipment?.carrier }}</span>
          <span *ngIf="n.shipment?.trackingCode"> / {{ n.shipment?.trackingCode }}</span>
        </div>
      </div>

      <div *ngIf="isBuyer()">
        <div class="action-buttons-row" *ngIf="buyerMustAct(n) || canMarkReceived(n)">
          <button
            *ngIf="buyerMustAct(n)"
            class="btn tertiary"
            (click)="openAction('payment')">
            Fiz minha parte
          </button>

          <button
            *ngIf="canMarkReceived(n)"
            class="btn"
            (click)="markReceived(n.id)"
            [disabled]="loadingReceived">
            {{ loadingReceived ? 'Confirmando...' : 'Produto recebido' }}
          </button>
        </div>

        <div *ngIf="n.payment?.paidAt" class="muted mtop">
          Pago em {{ n.payment?.paidAt | date:'short' }} — {{ n.payment?.method }}
        </div>

        <div *ngIf="n.evaluated" class="muted mtop">
          Produto recebido e negociação finalizada
        </div>

        <button
          *ngIf="canRate(n)"
          class="btn"
          (click)="openRating()">
          {{ currentRating ? 'Editar avaliação' : 'Avaliar negociação' }}
        </button>
      </div>

      <div class="action-links">
        <button class="link-btn" (click)="toggleComment()">
          {{ commentOpen ? 'Cancelar comentário' : 'Comentar negociação' }}
        </button>
        <button class="link-btn" (click)="openReport()">Denunciar negociação</button>
      </div>

      <div class="comment-box" *ngIf="commentOpen">
        <label>Comentário</label>
        <textarea [(ngModel)]="commentText" rows="3" placeholder="Compartilhe uma atualização sobre a negociação"></textarea>
        <p class="error" *ngIf="commentError">{{ commentError }}</p>
        <button class="btn" (click)="submitComment()" [disabled]="loadingComment">
          {{ loadingComment ? 'Enviando...' : 'Enviar comentário' }}
        </button>
      </div>
    </div>

    <div class="card action-card">
      <header>
        <h3>Ações da outra parte</h3>
        <span class="badge-role inverse">{{ isBuyer() ? 'Vendedor' : 'Comprador' }}</span>
      </header>

      <ul class="action-list">
        <li *ngIf="n.payment?.paidAt">
          Comprovou pagamento em {{ n.payment?.paidAt | date:'short' }}

          <button class="link-btn" *ngIf="n.payment?.comprovanteImage" (click)="openProofModal(n.payment?.comprovanteImage || null, 'Comprovante de pagamento')">
            Ver comprovante
          </button>
        </li>
        <li *ngIf="n.shipment?.trackingCode">
          Informou envio em {{ n.shipment?.sentAt | date:'short' }} — {{ n.shipment?.trackingCode }}
          <button class="link-btn" *ngIf="n.shipment?.proofImage" (click)="openProofModal(n.shipment?.proofImage || null, 'Comprovante de postagem')">
            Ver comprovante
          </button>
        </li>
        <li *ngIf="!n.payment && !n.shipment">Nenhuma ação registrada ainda.</li>
      </ul>
    </div>
  </section>

  <section class="proofs" *ngIf="hasShipment(n) || hasPayment(n)">
    <div class="card proof-card" *ngIf="hasShipment(n)">
      <h3>Envio</h3>
      <p *ngIf="n.shipment?.carrier">Transportadora: <strong>{{ n.shipment?.carrier }}</strong></p>
      <p *ngIf="n.shipment?.trackingCode">Código de rastreio: <strong>{{ n.shipment?.trackingCode }}</strong></p>
      <p *ngIf="n.shipment?.sentAt">Enviado em: <strong>{{ n.shipment?.sentAt | date:'short' }}</strong></p>
      <p *ngIf="n.shipment?.proofImage">Comprovante disponível</p>
      <button class="link-btn" *ngIf="n.shipment?.proofImage" (click)="openProofModal(n.shipment?.proofImage ?? null, 'Comprovante de postagem')">
        Ver comprovante de postagem
      </button>
      <div *ngIf="trackingList(n).length > 1" class="tracking-list">
        <span>Códigos adicionais:</span>
        <ul>
          <li *ngFor="let code of trackingList(n)">{{ code }}</li>
        </ul>
      </div>
    </div>

    <div class="card proof-card" *ngIf="hasPayment(n)">
      <h3>Pagamento</h3>
      <p *ngIf="n.payment?.method">Método: <strong>{{ n.payment?.method }}</strong></p>
      <p *ngIf="n.payment?.paidAt">Pago em: <strong>{{ n.payment?.paidAt | date:'short' }}</strong></p>
      <p *ngIf="n.payment?.comprovanteImage">Comprovante disponível</p>
      <button class="link-btn" *ngIf="n.payment?.comprovanteImage" (click)="openProofModal(n.payment?.comprovanteImage ?? null, 'Comprovante de pagamento')">
        Ver comprovante de pagamento
      </button>
    </div>
  </section>

  <section class="logs" *ngIf="n.logs?.length">
    <h3>Histórico da negociação</h3>
    <ul>
      <li *ngFor="let l of n.logs">
        <span class="log-date">{{ l.at | date:'short' }}</span>
        <span class="log-user">{{ l.by }}</span>
        <span class="log-message">{{ l.message }}</span>
      </li>
    </ul>
  </section>

  <section class="ratings" *ngIf="canRate(n) || currentRating || counterpartyRating || (n.status === 'concluido' || n.status === 'concluído')">
    <div class="ratings-header">
      <h3>Avaliações</h3>
    </div>
    
    <div class="ratings-list">
      <!-- Avaliação que o usuário atual fez -->
      <div class="rating-item" *ngIf="currentRating">
        <div class="rating-avatar">
          <span>{{ getCurrentUserInitial() }}</span>
        </div>
        <div class="rating-content">
          <div class="rating-header">
            <strong class="rating-author">{{ getCurrentUserName() }}</strong>
            <span class="rating-role">{{ roleLabel() }}</span>
            <span class="rating-date" *ngIf="currentRating.date || currentRating.createdAt">{{ (currentRating.date || currentRating.createdAt) | date:'dd/MM/yy, h:mm a' }}</span>
          </div>
          <div class="rating-stars-display">
            <span *ngFor="let star of [1,2,3,4,5]" class="star-display" [class.active]="star <= currentRating.ratingValue">★</span>
            <span class="rating-value-text">{{ currentRating.ratingValue }} de 5</span>
          </div>
          <p class="rating-comment" *ngIf="currentRating.comment">{{ currentRating.comment }}</p>
        </div>
      </div>
      
      <!-- Avaliação que a outra parte fez -->
      <div class="rating-item" *ngIf="counterpartyRating">
        <div class="rating-avatar">
          <span>{{ getCounterpartyInitial(n) }}</span>
        </div>
        <div class="rating-content">
          <div class="rating-header">
            <strong class="rating-author">{{ getCounterpartyRatingName(counterpartyRating) }}</strong>
            <span class="rating-role">{{ isBuyer() ? 'Vendedor' : 'Comprador' }}</span>
            <span class="rating-date" *ngIf="counterpartyRating.date || counterpartyRating.createdAt">{{ (counterpartyRating.date || counterpartyRating.createdAt) | date:'dd/MM/yy, h:mm a' }}</span>
          </div>
          <div class="rating-stars-display">
            <span *ngFor="let star of [1,2,3,4,5]" class="star-display" [class.active]="star <= counterpartyRating.ratingValue">★</span>
            <span class="rating-value-text">{{ counterpartyRating.ratingValue }} de 5</span>
          </div>
          <p class="rating-comment" *ngIf="counterpartyRating.comment">{{ counterpartyRating.comment }}</p>
        </div>
      </div>
      
      <!-- Mensagem quando não há avaliações -->
      <div class="no-ratings" *ngIf="!currentRating && !counterpartyRating">
        <p class="muted">Nenhuma avaliação ainda. Avalie a negociação quando ela estiver concluída!</p>
      </div>
    </div>
  </section>

  <section class="comments">
    <div class="comments-header">
      <h3>Comentários</h3>
      <span class="comment-count" *ngIf="n.comments?.length">{{ n.comments.length }} {{ n.comments.length === 1 ? 'comentário' : 'comentários' }}</span>
    </div>
    
    <div class="comment-list" *ngIf="n.comments?.length; else noComments">
      <div class="comment-item" *ngFor="let comment of n.comments">
        <div class="comment-avatar">
          <span>{{ getCommentAuthorInitial(comment) }}</span>
        </div>
        <div class="comment-content">
          <div class="comment-header">
            <strong class="comment-author">{{ getCommentAuthorName(comment) }}</strong>
            <span class="comment-role" *ngIf="comment.role">{{ comment.role === 'buyer' ? 'Comprador' : 'Vendedor' }}</span>
            <span class="comment-date" *ngIf="comment.createdAt">{{ comment.createdAt | date:'dd/MM/yy, h:mm a' }}</span>
          </div>
          <p class="comment-message">{{ comment.message }}</p>
        </div>
      </div>
    </div>
    
    <ng-template #noComments>
      <div class="no-comments">
        <p class="muted">Nenhum comentário ainda. Seja o primeiro a comentar!</p>
      </div>
    </ng-template>
  </section>
</main>

<!-- Modal pagamento -->
<div class="modal-backdrop" *ngIf="actionFormOpen && actionType==='payment'">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <h3>Informar pagamento</h3>
      <button class="close-btn" (click)="closeAction()">✕</button>
    </header>
    <section>
      <label>Método de pagamento</label>
      <select [(ngModel)]="method">
        <option value="PIX">PIX</option>
        <option value="TED">TED</option>
        <option value="BOLETO">Boleto</option>
      </select>

      <label>Comprovante (imagem)</label>
      <input type="file" accept="image/*" (change)="onPaymentProofSelected($event)" />
      <p class="error" *ngIf="paymentProofError">{{ paymentProofError }}</p>
      <div class="preview" *ngIf="paymentPreview">
        <img [src]="paymentPreview" alt="Comprovante pagamento" />
      </div>

      <button class="btn" (click)="markPaid(neg()?.id!)">Enviar comprovante</button>
    </section>
  </div>
</div>

<!-- Modal envio -->
<div class="modal-backdrop" *ngIf="actionFormOpen && actionType==='shipment'">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <h3>Informar postagem</h3>
      <button class="close-btn" (click)="closeAction()">✕</button>
    </header>
    <section>
      <label>Transportadora</label>
      <input type="text" [(ngModel)]="carrier" placeholder="Correios, Jadlog..." />

      <label>Código de rastreio</label>
      <input type="text" [(ngModel)]="tracking" placeholder="AA123..." />

      <label>Comprovante de postagem (imagem)</label>
      <input type="file" accept="image/*" (change)="onShipmentProofSelected($event)" />
      <p class="error" *ngIf="shipmentProofError">{{ shipmentProofError }}</p>
      <div class="preview" *ngIf="shipmentPreview">
        <img [src]="shipmentPreview" alt="Comprovante postagem" />
      </div>

      <button class="btn" (click)="markShipped(neg()?.id!)">Enviar informações</button>
    </section>
  </div>
</div>

<!-- Modal visualizar comprovante -->
<div class="modal-backdrop" *ngIf="viewProofOpen && proofModalImage">
  <div class="modal modal--image" role="dialog" aria-modal="true">
    <header>
      <h3>{{ proofModalTitle }}</h3>
      <button class="close-btn" (click)="closeProofModal()">✕</button>
    </header>
    <section class="image-view">
      <img [src]="proofModalImage!" [alt]="proofModalTitle" />
    </section>
  </div>
</div>

<!-- Modal denúncia -->
<div class="modal-backdrop" *ngIf="reportOpen">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <h3>Denunciar negociação</h3>
      <button class="close-btn" (click)="closeReport()">✕</button>
    </header>
    <section>
      <label>Motivo da denúncia *</label>
      <textarea [(ngModel)]="reportReason" rows="4" placeholder="Descreva o motivo da denúncia..."></textarea>
      
      <p class="error" *ngIf="reportError">{{ reportError }}</p>
      
      <div class="form-actions">
        <button class="btn secondary" (click)="closeReport()" [disabled]="loadingReport">Cancelar</button>
        <button class="btn" (click)="submitReport()" [disabled]="loadingReport">
          {{ loadingReport ? 'Enviando...' : 'Enviar denúncia' }}
        </button>
      </div>
    </section>
  </div>
</div>

<!-- Modal avaliação -->
<div class="modal-backdrop" *ngIf="ratingOpen">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <h3>Avaliar negociação</h3>
      <button class="close-btn" (click)="closeRating()">✕</button>
    </header>
    <section>
      <label>Avaliação *</label>
      <div class="rating-stars">
        <button
          *ngFor="let star of [1,2,3,4,5]"
          type="button"
          class="star-btn"
          [class.active]="star <= ratingValue"
          (click)="setRating(star)">
          ★
        </button>
        <span class="rating-value" *ngIf="ratingValue > 0">{{ ratingValue }} de 5</span>
      </div>

      <label>Comentário (opcional)</label>
      <textarea [(ngModel)]="ratingComment" rows="4" placeholder="Deixe um comentário sobre a negociação..."></textarea>
      
      <p class="error" *ngIf="ratingError">{{ ratingError }}</p>
      
      <div class="form-actions">
        <button 
          class="btn secondary" 
          (click)="closeRating()" 
          [disabled]="loadingRating">
          Cancelar
        </button>
        <button 
          *ngIf="currentRating"
          class="btn btn-danger" 
          (click)="deleteRating()" 
          [disabled]="loadingRating">
          {{ loadingRating ? 'Deletando...' : 'Deletar' }}
        </button>
        <button 
          class="btn" 
          (click)="submitRating()" 
          [disabled]="loadingRating || ratingValue < 1">
          {{ loadingRating ? 'Salvando...' : (currentRating ? 'Atualizar avaliação' : 'Enviar avaliação') }}
        </button>
      </div>
    </section>
  </div>
</div>

<ng-template #notfound>
  <main class="neg-detail"><p class="muted">Negociação não encontrada.</p></main>
</ng-template>
