<main class="main">
  <article class="collection-article">
    <div class="collection-header" *ngIf="collection as col; else carregando">
      <div class="collection-info">
        <ng-container *ngIf="!editMode; else editTitle">
          <h1>{{ col.name }}</h1>
        </ng-container>

        <ng-template #editTitle>
          <input
            [(ngModel)]="col.name"
            type="text"
            class="collection-title-input"
            placeholder="Nome da coleção"
          />
        </ng-template>

        <div class="collection-actions">
          <button class="add-book-btn" (click)="openAdd()">+ Adicionar Livro</button>
          <button class="edit-btn" (click)="toggleEditMode()">
            {{ editMode ? 'Concluir Edição' : 'Editar Coleção' }}
          </button>
        </div>
      </div>
    </div>

    <ng-template #carregando>
      <p>Carregando coleção...</p>
    </ng-template>

    <p *ngIf="!loading && error" class="error-text">{{ error }}</p>

    <!-- LISTA DE LIVROS -->
    <div class="book-grid">
      <div *ngFor="let book of books; let i = index; trackBy: trackById" class="book-wrapper">
        <app-card-book
          [titulo]="book.titulo"
          [ano]="book.ano ?? ''"
          [autor]="book.autor ?? ''"
          [status]="book.status ?? ''"
          [imageUrl]="book.imageUrl ?? ''"
          [collectionId]="collection?._id!"
          [id]="book._id">
        </app-card-book>

        <!-- Ações em modo edição -->
        <div *ngIf="editMode" class="book-actions">
          <button class="icon-btn"
                  [class.done]="coveredIds.has(book._id)"
                  *ngIf="book.imageUrl"
                  (click)="setAsCover(i)"
                  [disabled]="coverBusy || coveredIds.has(book._id)">
            {{ coveredIds.has(book._id) ? 'Capa definida' : 'Usar como capa' }}
          </button>

          <div class="inline-actions">
            <button class="edit-btn"  type="button" (click)="openEdit(i)">Editar</button>
            <button class="sell-btn"  type="button" (click)="openSell(book)">Vender</button>
            <button class="remove-book-btn" type="button" (click)="confirmRemove(i)">Remover</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ====================== MODAIS (UMA ÚNICA INSTÂNCIA) ====================== -->

    <!-- Adicionar livro -->
    <app-add-book-dialog
      *ngIf="addOpen"
      (close)="closeAdd()"
      (submit)="onAddSubmit($event)">
    </app-add-book-dialog>

    <!-- Editar livro -->
    <app-add-book-dialog
      *ngIf="editOpen"
      [dialogTitle]="'Editar livro'"
      [submitLabel]="'Atualizar'"
      [initial]="editInitial"
      [canClearImage]="true"
      (close)="closeEdit()"
      (submit)="onEditSubmit($event)">
    </app-add-book-dialog>

    <!-- Vender -->
    <app-sell-dialog
      *ngIf="sellOpen && sellBook"
      [book]="sellBook"
      (close)="closeSell()"
      (submit)="onSellSubmit($event)">
    </app-sell-dialog>

    <!-- Confirmar remoção -->
    <app-confirm-dialog
      *ngIf="confirmRemoveOpen"
      [title]="'Remover livro'"
      [message]="'Esta ação excluirá o livro desta coleção e do seu acervo.'"
      [confirmLabel]="'Remover'"
      [cancelLabel]="'Cancelar'"
      [danger]="true"
      (confirm)="doRemoveConfirmed()"
      (cancel)="closeConfirmRemove()">
    </app-confirm-dialog>

  </article>
</main>
