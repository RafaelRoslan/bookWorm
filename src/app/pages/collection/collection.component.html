<main class="main">
  <article class="collection-article">
    <div class="collection-header" *ngIf="collection as col; else carregando">
      <div class="collection-info">
        <ng-container *ngIf="!editMode; else editTitle">
          <h1>{{ col.name }}</h1>
        </ng-container>

        <ng-template #editTitle>
          <input
            [(ngModel)]="col.name"
            type="text"
            class="collection-title-input"
            placeholder="Nome da coleção"
          />
        </ng-template>

        <div class="collection-actions">
          <button class="add-book-btn" (click)="addBookToggle()">
            {{ showAddForm ? 'Cancelar' : '+ Adicionar Livro' }}
          </button>
          <button class="edit-btn" (click)="toggleEditMode()">
            {{ editMode ? 'Concluir Edição' : 'Editar Coleção' }}
          </button>
        </div>
      </div>

      <!-- Formulário inline para criar livro -->
      <form *ngIf="showAddForm" (ngSubmit)="submitAddBook()" class="inline-form">
        <div class="form-group">
          <label>Título *</label>
          <input [(ngModel)]="addForm.title" name="title" required placeholder="Ex.: Harry Potter" />
        </div>

        <div class="form-group">
          <label>Autor</label>
          <input [(ngModel)]="addForm.author" name="author" placeholder="Ex.: J.K. Rowling" />
        </div>

        <div class="form-group">
          <label>Descrição</label>
          <textarea [(ngModel)]="addForm.description" name="description" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>ISBN</label>
          <input [(ngModel)]="addForm.isbn" name="isbn" placeholder="Ex.: 978..." />
        </div>

        <div class="form-group">
          <label>Capa (imagem)</label>
          <input type="file" accept="image/*" (change)="onImageSelected($event)" />
          <small class="help-text">Tamanho máx: 200 KB (será redimensionada para ~600px de largura)</small>

          <!-- preview opcional -->
          <img *ngIf="addForm.image" [src]="addForm.image" alt="Preview" class="img-preview"/>
        </div>

        <div class="form-actions">
          <button type="submit" class="add-book-btn">Salvar</button>
          <button type="button" class="edit-btn" (click)="addBookToggle()">Cancelar</button>
        </div>
      </form>
    </div>

    <ng-template #carregando>
      <p>Carregando coleção...</p>
    </ng-template>

    <p *ngIf="!loading && error" class="error-text">{{ error }}</p>

    <div class="book-grid">
      <div *ngFor="let book of books; let i = index" class="book-wrapper">
        <app-card-book
          [titulo]="book.titulo"
          [ano]="book.ano ?? ''"
          [autor]="book.autor ?? ''"
          [status]="book.status ?? ''"
          [imageUrl]="book.imageUrl ?? ''"
          [collectionId]="collection?._id!"
          [id]="book._id"
        ></app-card-book>

        <!-- Ações em modo edição -->
        <div *ngIf="editMode && (!isEditing || editIndex !== i)" class="book-actions">
          <button class="icon-btn" *ngIf="book.imageUrl" (click)="setAsCover(i)">
            Usar como capa
          </button>

          <div class="inline-actions">
            <button class="edit-btn" (click)="startEdit(i)">Editar</button>
            <button class="sell-btn" (click)="openSell(book)">Vender</button>
            <button class="remove-book-btn" (click)="removeBook(i)">Remover</button>
          </div>
        </div>

        <!-- Form de edição inline para ESTE livro -->
        <form *ngIf="isEditing && editIndex === i" (ngSubmit)="submitEditBook()" class="edit-inline-form">
          <div class="form-group">
            <label>Título *</label>
            <input [(ngModel)]="editForm.title" name="edit_title" required />
          </div>

          <div class="form-group">
            <label>Autor</label>
            <input [(ngModel)]="editForm.author" name="edit_author" />
          </div>

          <div class="form-group">
            <label>Descrição</label>
            <textarea [(ngModel)]="editForm.description" name="edit_description" rows="2"></textarea>
          </div>

          <div class="form-group">
            <label>ISBN</label>
            <input [(ngModel)]="editForm.isbn" name="edit_isbn" />
          </div>

          <div class="form-group">
            <label>Nova capa (opcional)</label>
            <input type="file" accept="image/*" (change)="onEditImageSelected($event)" />
            <img *ngIf="editForm.image" [src]="editForm.image" alt="Preview" class="img-preview-sm" />
          </div>

          <div class="form-actions">
            <button type="submit" class="add-book-btn">Salvar</button>
            <button type="button" class="edit-btn" (click)="cancelEdit()">Cancelar</button>
          </div>
        </form>

      </div>
    </div>

    <app-sell-dialog
      *ngIf="sellOpen && sellBook"
      [book]="sellBook"
      (close)="closeSell()"
      (submit)="onSellSubmit($event)">
    </app-sell-dialog>

  </article>
</main>
